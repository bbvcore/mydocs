---
title: Guía pentesting
---
# :dart: Básico pentesting
## &#x1F427; Linux
Procedimientos útiles en sistemas operativos **GNU/Linux** para procedimientos básicos de pruebas de penetración.

### &#x1F50D;  Escaneo de puertos
#### &#x1F4BB; Nmap
Nmap es un escaneo de puertos muy preciso, el cual debido a sus diferentes opciones y posibilidades de ejecución de scripts programados en <b>LUA</b>, ofrece unos resultados muy buenos.

<details>
<summary>
Principales <b>características</b> y <b>uso</b> de <b>Nmap</b>.
</summary>

Para un escaneo básico con nmap solo hace falta indicarle una dirección IP
```bash
nmap <IP> # escaneo básico de IP
nmap -sCV <IP> # escaneo usando los scripts básicos y buscando servicios 
nmap -Pn <IP> # escaneo sin hacer Ping
nmap -sCTUV -p- -T3 <IP> # escaneo con scripts básicos, TCP, UDP, versión servicios, todos los puertos y con control del tiempo con una agresividad media
nmap -A <IP> # opción de escaneo que incorpora por defecto detección de OS, servicios y versiones, rastreo ruta y script de detección de vulnerabilidades
nmap --script vuln <IP> # escaneo en busca de vulnerabilidades
nmap --top-ports 1000 <IP> # escanea los 1000 puertos mejor conocidos y más usados
nmap -p [1-1024 | U:53,T:80,8080 | 22,80,8080 ] <IP> # especificar un o varios puertos a escanear, se puede específicar el protocolo también
```


</details>


### &#x1F41E;  Escaneo de vulnerabilidades
Se puede utilizar también en este tipo de escaneos **nmap**, haciendo caso del parámetro **vuln**. Pero más especificamente se usa la herramienta basada en **OpenVas** que es Open Source **Greenbone** o un software comercial llamado **Nessus**.

#### &#x1F4BD; GreenBone
Se basa en OpenVas y puede dar bastantes problemas de depenencias para usarlo en función del OS donde se vaya a configurar, por ello una opción rápida y potente es usar la imagen ISO existente para GreenBone.
:::tip
<a href="https://www.greenbone.net/en/openvas-free/">OpenVAS/Greenbone ISO</a>
:::




### &#x1F310; Acceso remoto
Procedimientos de acceso o conexión remota a una máquina o equipo objetivo **"target"**.
#### SSH
Es un protocolo de conexión segura hacía un servidor remoto a través de una red pública o no segura. Permite gestionar servidores mediante comandos remotos y de esta forma poder acceder a recursos.
<details>
<summary>
Ejemplod de uso de SSH y de SCP
</summary>

```bash
ssh user@IP/domain
ssh -L port:host-local:port user@IP/domain
```
:::Tip
El parámetro L sirve para el reenvio de puertos locales, creando de esta forma un tunneling entre el puerto local de una máquina al puerto remoto de otra máquina. Los argumentos necesarios son el puerto local, la IP remota y el puerto remoto.
:::

La forma de transferir ficheros con ssh es mediante el uso del comando scp.
```bash
scp file/dir user:IP/domain:/path
```
</details>

#### Netcat
Es una utilidad de línea de comandos que permite **escribir** y **leer** *datos* en red a través de **conexiones** *TCP/UDP*. Para ello se necesita de un servidor al que conectarse y un puerto de escucha activo.

<details>
<summary>
Ejemplo de uso de la herramienta netcat estableciendo conexión con un servidor Python.
</summary>

**Servidor creado con Python**
```bash
python3 -m http.server 9999
```
**Conexión al servidor creado con nc**
```bash
nc <IPserver> 9999
```
En caso positivo se obtendría una respuesta donde se recibirían las cabeceras web.
```bash
GET / HTTP/1.1
Host: localhost
```
</details>

### Captura tráfico
#### TCPdump
```bash 
tcpdump -i "<interface>" "<port>" "<fichero>"
```
### &#x1F5C4; Bases de datos
#### SQLmap
```
sqlmap -r sqli-accept-cat.req -p catName --level=5 --tables --dump --risk=3 ---dbms=sqlite
--threads=10
```
### &#128269; Rastreo y fuzzing
#### Gospider
Se utiliza para rastrear sitios web obteniendo reconocimiento y enumeración. Sirve para buscar URLs, endpoints, enlaces en el HTML, datos de consultas GET/POST.
```bash
gospider -s
```
#### Dirsearch
Mediante fuerza bruta permite descubrir directorios y archivos ocultos en servidores. 
```bash
dirsearch -u <IP/dominio> -e php, html -x 403,404 -t 50 -o data.txt
```
:::tip
- u: dominio o IP
- e: extensiones a buscar
- x: códigos de respuesta a ignorar
- t: número de hilos
- o: archivo de salida
- r: recursivo
:::

#### Feroxbuster
Realiza un asedio a peticiones HTTP para poder descubrir directorios ocultos, ficheros, rutas..
```bash 
feroxbuster -u "<host>" -w "<wordlist>"
```
:::tip
- u: target
- w: diccionario
- x: extensiones a probar
- t: número de hilos
- o: archivo de salida
- r: recursivo
- q: silencioso
:::

#### Ffuf
Búsqueda de directorios y archivos además de realizar fuzzing en la búsqueda de parámetros o subdominios.
```bash
ffuf -c -u "<host>" -H "host:FUZZ.<target-url>"
```
:::tip
- FUZZ: variable que se reemplaza en cada búsqueda
- w: diccionario
- e: extensiones a probar
- mc <number>: filtra por código de estado HTTP, por ejemplo "mc: 200"
- recursion
- H: añae cabeceras personalizadas
- fs: filtra por tamaño de respuesta
- recursion-depth: nivel de profundidaz en la recursión
:::

### &#x26A0; XSS
Cross Site Scripting para llevar a cabo inyección JS de código malicioso en páginas web.
#### XSS Reflejado
El payload viaja en la petición **HTTP** donse se *"refleja"* el código en el HTML si no hay sanitización, de esta forma de esta forma el servidor lo incrusta en el HTML que devuelve y de ahí el problema potencial. Este código iría en un input de HTML o podría ir en la URL.
```javascript
<script>alert("Codigo XSS reflejado")</script>
```
Este payload iría **dentro** del <u>código HTML</u> **que devuelve el servidor** <u>sin haberlo sanitizado</u> y se intepretaría como JS, dando lugar a la posibilidad de ejecución de código JS malicioso.

#### XSS Almacenado
Este caso es más grave que el **XSS** reflejado porque ahora el código se almacena en una base de datos y puede ser ejecutado multiples veces.
Además de en una base de datos podría ser almacenado en otros lugares, como ficheros de configuración, logs del sistema o en la memoria caché.
```javascript
<script>while(true){};</script>
```
En este caso sería la ejecución de un **loop infinito** que podría provocar la imposibilidad del uso de un sistema online por parte de los usuarios al generarse un bloqueo del navegador del cliente mientras se consultaba algún valor de la aplicación web.
```php
<?php
$id = $_GET['id'];
$conn = new mysqli("localhost", "root", "", "xss_attack");
$res = $conn->query("SELECT * FROM productos WHERE id=$id");
$row = $res->fetch_assoc();
echo "<h1>".$row['nombre']."</h1>";
echo "<p>".$row['descripcion']."</p>"; 
?>
```
Al realizar esta consulta y al acceder a los datos introducidos sin sanitización tiene lugar el ataque de XSS.

#### XSS DOM
La vulnerabilidad está en el cliente, es decir en el navegador web del usuario, donde el script puede leer datos del navegador de los objetos del **DOM**, puede afectar al **BOM**, pero normalmente las acciones acaban realizándose en el **DOM**, por ello para simplificar se le denomina DOM.
```html
<div id="div-donde-incrustrar"></div>
```
```javascript
document.getElementById("div-donde-incrustrar").innerHTML = location.hash.substring(1);
```
De esta forma se consigue el código que viaja después del hash, y con el método substring con el argumento 1, indica que empieza la cadena a almacenar desde la posición 1, que es donde empieza el código del script, de esta forma se omite coger la almohadilla (#)
```html
http://localhost/pagina-atacada.html#<script>while(true){}</script>
```
Mediante una url se pasa el script a insertar en la página HTML. Por ello para poder ejecutar o explotar esta vulnerabilidad la página web debería de leer datos de la URL como de location.hash o location.search e incluso location.pathname, y luego insertarlos dentro del HTML con algún método potencialmente inseguro como innerHTML.

## &#x1FA9F; Windows
### Crackmapexec (CME)
Es una herramienta para labores de penetración en sistemas operativos Windows, que soporta los principales protocolos que usa el OS como son SMB o WinRM. Originalmente la herramienta para estos fines más usada era **netexec**, pero ahora forma parte de crakmapexec.

<details>
<summary>
Ejemplo de uso de la herramienta
</summary>

<b>Estructura básica del uso de cme</b>
```cmd
cme <protocolo> <IP> 
-u <user>
-p <password>
-H <hash NTLM>
-d <dominio>
-x <comando>
--share <enumera shares de SMB>
--users <enumera users>
--groups <enumera groups>
--pass-pol <obtención de la política de contraseñas>
-M <módulo post-explotación>
-o <opciones para módulos>
```
<b>Ejemplos</b>
```powershell
cme smb <IP> -u admin -p pass -x "whoami"
cme smb <IP> -u user -p pass --shares
cme smb <IP> -u admin -p pass -M mimikatz
```

</details>



## MimiKatz
Permite extraer contraseñas de inicio de sesión, tickets de kerberos, hashes NTLM y certificados en Windows desde la memoria. Puede desencriptar contraseñas alojadas en la memoria, puede usar hashses en vez de usar las contraseñas primarias, extraer de memoria los tickets de Kerberos además de poder generar un **golden ticket**, que se trata de un ticket falsificado para poder acceder a cualquier cuenta en la red.

### BloodHound
Herramienta para inspeccionar objetos de Directorio Activo, requiere del sistema gestor de base de datos neo4j y de una interfaz gráfica para visualizar los datos del AD obtenidos como objetos JSON.

#### Bloodhound-python
Recolector de datos del directorio activo para bloodhound

#### Bloodhound-AD
Permite cambiar passwords de usuarios a raíz de una credenciales válidas en el sistema

### Evil-WinRM
Permite explotar WinRM para poder acceder de forma remota a equipos windows mediante sesión de consola power shell.

:::tip
**GEM** es el gestor de paquetes de Ruby
:::

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install ruby ruby-dev libffi-dev build-essential -y
sudo gem install evil-winrm
evil-winrm -i <IP> -u "<user>" -p "<password>"
```
:::tip[WinRM]
Es la Administración remota de Windows que hace uso de base del protocolo SOAP, permitiendo la comunicación entre diferentes sistemas. El protoloco que esta debajo es WS-Management que se basa en el mencionado SOAP. Además WinRM permite la ejecución de comandos PowerShell. Opciones de parámetros:
- s: subir sccripts de PS
- e: carpeta de ejecutables
- r: comando remoto
- p: puerto
- S: usar SSL
:::